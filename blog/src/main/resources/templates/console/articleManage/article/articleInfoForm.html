<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../../../layui/css/layui.css">
</head>
<body>

<div style="margin-top: 0.2rem;">

    <form class="layui-form layui-form-pane" action=""  lay-filter="articleInfoForm">
        <div class="layui-form-item layui-hide">
            <div class="layui-input-block">
                <input type="text" name="id" disabled autocomplete="off"  class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <div class="layui-input-block">
                <input type="text" name="adId" disabled autocomplete="off"  class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <div class="layui-input-block">
                <input type="text" name="arId" disabled autocomplete="off"  class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">标题</label>
            <div class="layui-input-block">
                <input type="text" name="title" lay-verify="required" autocomplete="off" placeholder="请输入标题" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">文章摘要</label>
            <div class="layui-input-block">
                <textarea name="descn" placeholder="请输入内容, 字符长度不能超过2000" lay-verify="required|descn" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item"  lay-filter="tagSelectDiv">
            <label class="layui-form-label">分类</label>
            <div class="layui-input-inline">
                <select  id="categorySelect" name="cid" lay-search="" lay-verify="required" lay-filter="categorySelect">
                </select>
            </div>
        </div>

        <div class="layui-form-item"  lay-filter="tagSelectDiv">
            <label class="layui-form-label">标签</label>
            <div class="layui-input-inline">
                <select  id="tagSelect" lay-search="" lay-filter="tagSelect">
                </select>
            </div>
        </div>
        <div class="layui-form-item" >
            <div class="layui-inline" id="tagCheckboxDiv" lay-filter="tagCheckboxDiv">
            </div>
        </div>

        <div class="layui-form-item" pane="">
            <label class="layui-form-label">封面</label>

            <div class="layui-input-inline">
                <div class="layui-form-item layui-hide">
                    <div class="layui-input-block">
                        <input type="text" name="imgUrl" disabled autocomplete="off"  class="layui-input">
                    </div>
                </div>

                <div class="layui-upload" style="margin-left: 0.4rem;">
                    <button type="button" class="layui-btn" id="uploadImg">上传图片</button>
                    <div class="layui-upload-list">
                        <table class="layui-table" id="fileFieldTable">
                            <tr>
                                <th>文件名：</th>
                            </tr>
                            <tr>
                                <th>大小：</th>
                            </tr>
                            <tr>
                                <th>像素：</th>
                            </tr>
                            <!--<tbody id="demoList"></tbody>-->
                        </table>
                        <img class="layui-upload-img" id="demo1"  name="imgUrl" width="200">
                        <p id="demoText"></p>
                    </div>
                    <!--<button type="button" class="layui-btn" id="testListAction">开始上传</button>-->
                </div>

            </div>
        </div>


        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">创建时间</label>
                <div class="layui-input-inline">
                    <input type="text" name="createTime" id="createTime"
                           placeholder="yyyy-MM-dd HH:mm:ss" disabled autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">修改时间</label>
                <div class="layui-input-inline">
                    <input type="text" name="updateTime" id="updateTime"
                           placeholder="yyyy-MM-dd HH:mm:ss" disabled autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>


        <div class="layui-form-item" style="display: none;">
            <button class="layui-btn " lay-submit lay-filter="saveArticleInfo" id="saveArticleInfo">跳转式提交</button>
        </div>
    </form>
</div>

<script src="../../../layui/layui.js"></script>
<script>
    var form;
    layui.use(['form', 'layedit', 'laydate', 'upload'], function(){
        form = layui.form;
        var layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , $ = layui.jquery
            , upload = layui.upload;;
        //日期
        laydate.render({
            elem: '#date'
        });

        //普通图片上传
        var uploadInst = upload.render({
            elem: '#uploadImg'
            ,url: '/console/file/upload/'
            ,done: function(res){
                //如果上传失败
                if(res.code > 0){
                    return layer.msg('上传失败');
                }
                //上传成功
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传成功</span>');
            }
            // ,auto: false
            ,error: function(){
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function(){
                    uploadInst.upload();
                });
            }
            ,choose: function(obj){
                //读取本地文件
                obj.preview(function(index, file, result){
                    $('#demo1').attr('src', result);
                    var width  = $('#demo1')[0].naturalWidth;
                    var height  = $('#demo1')[0].naturalHeight;

                    $('#fileFieldTable').html('');
                    var tr = '<tr>' +
                        '                                <th>文件名：' + file.name + '</th>' +
                        '                            </tr>' +
                        '                            <tr>' +
                        '                                <th>大小：' + (file.size / 1014).toFixed(1) + 'kb</th>' +
                        '                            </tr>' +
                        '                            <tr>' +
                        '                                <th>像素：'+width+'*'+height+'</th>' +
                        '                            </tr>';
                    $('#fileFieldTable').append(tr);
                });
            }
        });

        form.on('select(tagSelect)', function(data){
            var selectedOption = data.elem.selectedOptions[0];
            var text = selectedOption.text;
            var value = selectedOption.value;

            var cb = $('#tagCheckboxDiv > #cb'+value);
            if (cb.length > 0) {
                cb.attr('checked', true);
                $(cb[0].nextSibling).addClass('layui-form-checked');
                // form.render('checkbox');
                return;
            }

            var cbHtml = '<input type="checkbox" id="cb'+value+'" name="tags['+value+']" value="'+value+'" checked title="'+text+'">';
            $('#tagCheckboxDiv').append(cbHtml);
            form.render('checkbox');
        });

        form.verify({
            descn : function (value, item) {
                if (value.length > 2000) {
                    return '字符数不能超过2000个';
                }
            }
        });

        //监听提交
        form.on('submit(saveArticleInfo)', function(data){
            /*parent.layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            })*/
            var field = data.field;
            var tagStr = [];
            for (var o in field) {
                if (o != null && o.startsWith('tags')) {
                    var value = field[o];
                    tagStr.push(value);
                }
            }
            field['tids']=tagStr;

            $.ajax({
                type: 'POST',
                url: '/console/articleDraft/saveInfo',
                dataType: 'json',
                data: JSON.stringify(field),//往后台发送的是data.field，即一个{name：value}的数据结构
                cache: false,
                contentType: 'application/json;charset=UTF-8',
                async: false,
                beforeSend: function(xhr) {
                    parent.layer.msg('正在提交', {
                        icon: 16,
                        // ,shade: 0.01,
                        shadeClose: false
                    });
                },
                success: function (rs, textStatus, jqXHR) {
                    // this.closeLoading();
                    if (rs.code == 0) {
                        parent.layer.alert('保存成功');
                        status = 'success';
                    } else {
                        status = 'error';
                        parent.layer.alert(rs.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    // this.closeLoading();
                    console.log("textStatus: "+textStatus, "errorThrown: "+errorThrown);
                    parent.layer.alert(textStatus);
                },
                statusCode: {
                    404: function () {
                        parent.layer.alert("404 访问路径不正确");
                    },
                    415: function () {
                        parent.layer.alert("415 内容类型不匹配");
                    },
                    400: function () {
                        parent.layer.alert("400 bad请求");
                    },
                    500: function () {
                        parent.layer.alert("500 服务器异常");
                    }
                },
            });
            return false;
        });

    });

    function initFormFieldVal(data) {
        layui.use(['form'], function () {
            form = layui.form;
            var $ = layui.jquery;

            var event = {
                initTagSelect: function () {
                    $.ajax({
                        type:'get',
                        url: '/console/tag/findAll',
                        dataType: 'json',
                        async: false,
                        success: function (rs, arg1, arg2) {
                            $('#tagSelect').html('');
                            var data = rs.data;
                            var optionHtml = ' <option value="">直接选择或搜索选择</option>';
                            for (var i = 0; i < data.length; i++) {
                                var o = data[i];
                                var value = o.tid;
                                var name = o.name;
                                optionHtml += '<option value="'+value+'">'+name+'</option>';
                            }
                            $('#tagSelect').append(optionHtml);
                            form.render('select');
                        },
                        error: function (arg1, arg2, arg3) {
                            console.log( arg1, arg2, arg3);
                        }
                    })
                },
                initCategorySelect: function () {
                    $.ajax({
                        type:'get',
                        url: '/console/category/findAll',
                        dataType: 'json',
                        async: false,
                        success: function (rs, arg1, arg2) {
                            $('#categorySelect').html('');
                            var data = rs.data;
                            var optionHtml = ' <option value="">直接选择或搜索选择</option>';
                            for (var i = 0; i < data.length; i++) {
                                var o = data[i];
                                var value = o.cid;
                                var name = o.name;
                                optionHtml += '<option value="'+value+'">'+name+'</option>';
                            }
                            $('#categorySelect').append(optionHtml);
                            form.render('select');
                        },
                        error: function (arg1, arg2, arg3) {
                            console.log( arg1, arg2, arg3);
                        }
                    })
                }
            };

            event.initTagSelect();
            event.initCategorySelect();

            var tags = data.tags;
            if (tags != null && tags.length > 0) {
                var cbHtml = '';
                for (var i = 0; i < tags.length; i++) {
                    var o = tags[i];
                    var value = o.tid;
                    var text = o.name;
                    cbHtml += '<input type="checkbox" id="cb'+value+'" name="tags['+value+']" value="'+value+'" checked title="'+text+'">';
                }
                $('#tagCheckboxDiv').append(cbHtml);
            }
            // form.render('checkbox');

            //表单初始赋值
            form.val('articleInfoForm', {
                "id": data.id,
                "arId": data.arId,
                "adId": data.adId,
                "cid": data.cid,
                "title": data.title // "name": "value"
                ,"createTime": data.createTime
                ,"updateTime": data.updateTime
                ,"descn": data.descn
                ,"imgUrl": data.imgUrl
            });
        });

    }


</script>

</body>
</html>